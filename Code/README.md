# Pneumonia X‑Ray Classification (Normal vs Pneumonia)

Deep learning project for **binary classification of chest X‑rays** into **NORMAL** vs **PNEUMONIA**.
The project includes:
- a **demo pipeline** (`run.py`) that loads a saved model and reports test performance,
- a **full experiment pipeline** with **5‑fold stratified cross‑validation** and ablations (activation/dropout/depth/BN/optimizer),
- **transfer learning** baselines (pretrained ResNet/DenseNet/EfficientNet) for comparison.

## Author
- **Name:** Basel Altamimi
- **Student ID:** 163880

---

## Repository structure

```
pneumonia_classification/
├── run.py                 # DEMO: loads trained_model.pth and evaluates on test set (+ saves plots)
├── train_and_save.py      # Trains demo model and saves trained_model.pth
├── trained_model.pth      # Trained checkpoint used by run.py (generated by train_and_save.py)
│
├── config.py              # Defaults: img_size=150, batch_size=32, epochs=25, n_folds=5, etc.
├── dataset.py             # Data loading + augmentation strategies + CV utilities
├── models.py              # Custom CNN + pretrained model wrappers (ResNet/DenseNet/EfficientNet…)
├── trainer.py             # Training loops, early stopping, metrics (Acc/Prec/Recall/F1/AUC/Spec.)
├── experiments.py         # Experiment runner: ablations + pretrained comparisons (CV)
├── visualization.py       # Plot utilities (results charts)
├── utils.py               # Helpers (logging, seeding, filesystem)
├── main.py                # CLI entrypoint to run experiments
│
├── data/
│   └── chest_xray/        # Dataset root (not included)
│       ├── train/         # NORMAL/, PNEUMONIA/
│       ├── val/           # NORMAL/, PNEUMONIA/
│       └── test/          # NORMAL/, PNEUMONIA/
│
└── results/               # Generated results (json/csv + plots)
```

---

## Dataset

This project expects the **Kaggle Chest X‑Ray Pneumonia** dataset arranged as above.

Kaggle link: https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia

---

## Setup

### Requirements
- Python 3.8+
- PyTorch + torchvision
- numpy, pandas, scikit‑learn, matplotlib, tqdm

Install dependencies:
```bash
pip install -r requirements.txt
```

---

## Quickstart

### 1) Put the dataset in the expected folder
```
data/chest_xray/test/NORMAL
data/chest_xray/test/PNEUMONIA
```
(Train/val folders are not required for the demo run, only for retraining/experiments.)

### 2) Run the demo
```bash
python3 run.py
```

### Demo outputs
`run.py`:
- loads `trained_model.pth`,
- runs inference on the **test** split,
- prints a classification report + confusion matrix,
- saves:
  - `results_demo.png` (confusion matrix + confidence plots + metric summary)
  - `sample_predictions.png` (example predictions with confidence)

It automatically uses **CUDA** if available.

---

## Training the demo checkpoint (optional)

If you want to regenerate `trained_model.pth`:
```bash
python3 train_and_save.py
```

Notes:
- uses a **custom CNN** (the same as the project’s custom CNN baseline),
- includes moderate augmentation and imbalance handling (weighted sampling),
- saves a checkpoint containing the model weights + the model configuration so the demo can recreate the exact architecture.

---

## Full experiments (cross‑validation + comparisons)

The experiments are designed to answer: **what works best for pneumonia classification?**
They include:
- **Custom CNN ablations**: activation, dropout, depth, batch norm, optimizer
- **Pretrained comparisons**: ResNet18/34/50, DenseNet121, EfficientNet‑B0 (1‑channel X‑ray adaptation)

### Run all experiments (default)
```bash
python3 main.py --mode full
```

### Quick mode (faster sanity run)
```bash
python3 main.py --mode quick
```

Useful flags:
```bash
python3 main.py --mode full --n_folds 5 --epochs 25 --batch_size 32
```

Results are saved under `results/` (aggregated metrics + fold histories + plots).

---

## Models and what “Custom CNN” means here

### Custom CNN
The baseline CNN is built from repeated convolutional blocks:
- **Conv2d → (BatchNorm optional) → Activation → MaxPool2d → (Dropout2d optional)**,
followed by an MLP head:
- **Linear → Activation → Dropout**,
and a final binary output.

This baseline is used for the **ablation studies** (activation/dropout/depth/BN/optimizer), because it’s fully controlled and easy to modify.

### Pretrained models (comparison only)
Pretrained backbones reuse ImageNet features and are adapted for medical X‑rays by:
- modifying the **first convolution** to accept **1‑channel grayscale** input,
- replacing the classifier head for binary output.

---

## Metrics

Each experiment reports (mean ± std over CV folds):
- Accuracy
- Precision
- Recall
- F1
- AUC
- Specificity (from confusion matrix)

Because this is a medical task, **Recall** is important to reduce false negatives (missed pneumonia).

---

## Reproducing the paper-style results

The plots that are generated (F1 ranking, radar comparison, fold variance, learning curves, confusion matrices) are produced from:
- saved experiment results (JSON/CSV) and
- `visualization.py` helpers.

---

## Notes
- Default config: **img_size=150**, **batch_size=32**, **epochs=25**, **n_folds=5** (see `config.py`).
- GPU usage: code selects `cuda` when available; CPU otherwise.
- Dataset is not included in the repo.

